name: Update pinned requirements

on:
  schedule:
  - cron: 0 12 * * 1
  workflow_dispatch:

jobs:
  update-requirements:
    name: Regenerate requirements.txt
    runs-on: ubuntu-latest
    if: github.repository == 'PlasmaPy/PlasmaPy'

    steps:

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.12

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Install uv
      run: python -m pip install uv

    - name: Generate top-level requirements.txt with all extras
      run: |
        python -m uv pip compile pyproject.toml -p 3.12 -U --all-extras -o requirements.txt

    - name: Generate doc build requirements file with most recent Python
      run: |
        python -m uv pip compile pyproject.toml -p 3.12 -U --extra docs -o requirements/requirements_py312_docs.txt

    - name: Generate requirements files for different Python versions
      run: |
        python -m uv pip compile pyproject.toml -p 3.12 -U --extra tests -o requirements/requirements_py312_tests.txt
        python -m uv pip compile pyproject.toml -p 3.11 -U --extra tests -o requirements/requirements_py311_tests.txt
        python -m uv pip compile pyproject.toml -p 3.10 -U --extra tests -o requirements/requirements_py310_tests.txt

    - name: Generate requirements file for minimum versions of dependencies
      run: |
        python -m uv pip compile pyproject.toml -p 3.10 -U --extra tests -o requirements/requirements_py310_tests_minimal.txt --resolution lowest-direct

    # When a PR is created by a GitHub Action, normally the checks will
    # not be run. While the simplest workaround would have been to open
    # and close the PR, an alternative is to authenticate with GitHub
    # App generated tokens (as done below). The instructions for how to
    # do this are in the documentation for the create-pull-request
    # action.

    - uses: tibdex/github-app-token@v2
      id: generate_token
      with:
        app_id: ${{ secrets.APP_ID }}
        private_key: ${{ secrets.APP_PRIVATE_KEY }}

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ steps.generate_token.outputs.token }}
        commit-message: Regenerate requirements.txt
        title: Update pinned requirements
        body: |
          This PR regenerates [`requirements.txt`](https://github.com/PlasmaPy/PlasmaPy/blob/main/requirements.txt) and the requirements files in [`requirements/`](https://github.com/PlasmaPy/PlasmaPy/blob/main/requirements. These files define Python environments that are used in certain CI checks, as well as by integrated development environments (IDEs).

          If all tests pass, please merge this PR. If any checks fail due to changes in the packages that we depend on, this PR may be used to perform the fixes that are necessary to get the checks to pass again.
        labels: No changelog entry needed, dependencies
        delete-branch: true
        base: main
